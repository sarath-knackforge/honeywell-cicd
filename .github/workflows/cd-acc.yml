

name: CD-ACC

on:
  push:
    branches:
      - main   # runs only after PR is merged into main

jobs:
  deploy-acc:
    name: Deploy to ACC Databricks Workspace
    runs-on: ubuntu-latest

    environment:
      name: acc   # optional GitHub Environment (approval gate)

    permissions:
      contents: read

    env:
      # ACC workspace credentials
      DATABRICKS_HOST: ${{ vars.DATABRICKS_ACC_HOST }}
      DATABRICKS_CLIENT_ID: ${{ secrets.DATABRICKS_ACC_CLIENT_ID }}
      DATABRICKS_CLIENT_SECRET: ${{ secrets.DATABRICKS_ACC_CLIENT_SECRET }}
      DATABRICKS_BUNDLE_ENV: acc

    steps:
      # ------------------------------------------------------------
      # 1ï¸âƒ£ Checkout main branch
      # ------------------------------------------------------------
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ------------------------------------------------------------
      # 2ï¸âƒ£ Install Databricks CLI
      # ------------------------------------------------------------
      - name: Install Databricks CLI
        uses: databricks/setup-cli@v0.246.0

      # ------------------------------------------------------------
      # 3ï¸âƒ£ Install uv (REQUIRED for bundle build)
      # ------------------------------------------------------------
      - name: Install uv
        uses: astral-sh/setup-uv@v5

      # ------------------------------------------------------------
      # 4ï¸âƒ£ Configure Databricks CLI (ACC profile)
      # ------------------------------------------------------------
      - name: Configure Databricks CLI (ACC)
        run: |
          mkdir -p ~/.databricks
          cat > ~/.databrickscfg << EOF
          [adb-7405613992811422]
          host = ${DATABRICKS_HOST}
          client_id = ${DATABRICKS_CLIENT_ID}
          client_secret = ${DATABRICKS_CLIENT_SECRET}
          EOF

      # ------------------------------------------------------------
      # 5ï¸âƒ£ Deploy bundle to ACC workspace
      # ------------------------------------------------------------
      - name: Deploy bundle to ACC workspace
        run: |
          databricks bundle deploy \
            --profile acc \
            --var="git_sha=${{ github.sha }}" \
            --var="branch=main"
          
          databricks bundle run -t acc deployment
                        
          echo "DEPLOY_STATUS=success" >> $GITHUB_ENV
      
      - name: Create PR from stage to main
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GIT_PR_TOKEN }}
        run: |
          # Avoid duplicate PRs
          if gh pr list --base main --head feature/stage --state open --json number | jq -e '. | length > 0'; then
            echo "PR already exists. Skipping."
            exit 0
          fi
          gh pr create \
            --base release \
            --head main \
            --title "ðŸš€ Promote stage â†’ main (Databricks deploy successful)" \
            --body "Automated PR after successful Databricks deployment."
