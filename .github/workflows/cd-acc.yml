# name: CD-ACC

# on:
#   push:
#     branches:
#       - main

# jobs:
#   deploy-acc:
#     name: Deploy to ACC Databricks Workspace
#     runs-on: ubuntu-latest

#     environment:
#       name: acc   # GitHub Environment (optional approval gate)

#     permissions:
#       contents: read

#     env:
#       # ðŸ‘‰ ACC WORKSPACE CREDENTIALS (DIFFERENT FROM DEV)
#       DATABRICKS_HOST: ${{ vars.DATABRICKS_ACC_HOST }}
#       DATABRICKS_CLIENT_ID: ${{ secrets.DATABRICKS_ACC_CLIENT_ID }}
#       DATABRICKS_CLIENT_SECRET: ${{ secrets.DATABRICKS_ACC_CLIENT_SECRET }}
#       DATABRICKS_BUNDLE_ENV: acc

#     steps:
#       # ------------------------------------------------------------
#       # 1ï¸âƒ£ Checkout main branch
#       # ------------------------------------------------------------
#       - name: Checkout source
#         uses: actions/checkout@v4
#         with:
#           fetch-depth: 0

#       # ------------------------------------------------------------
#       # 2ï¸âƒ£ Install Databricks CLI
#       # ------------------------------------------------------------
#       - name: Install Databricks CLI
#         uses: databricks/setup-cli@v0.246.0

#       # ------------------------------------------------------------
#       # 3ï¸âƒ£ Deploy bundle to ACC workspace
#       # ------------------------------------------------------------
#       - name: Deploy bundle to ACC workspace
#         run: |
#           databricks bundle deploy \
#             --var="git_sha=${{ github.sha }}" \
#             --var="branch=main"

#       # ------------------------------------------------------------
#       # 4ï¸âƒ£ Run ACC deployment job
#       # ------------------------------------------------------------
#       # - name: Run ACC deployment workflow
#       #   run: |
#       #     databricks bundle run deployment -t acc


name: CD-ACC

on:
  push:
    branches:
      - main   # runs only after PR is merged into main

jobs:
  deploy-acc:
    name: Deploy to ACC Databricks Workspace
    runs-on: ubuntu-latest

    environment:
      name: acc   # optional GitHub Environment (approval gate)

    permissions:
      contents: read

    env:
      # ACC workspace credentials
      DATABRICKS_HOST: ${{ vars.DATABRICKS_ACC_HOST }}
      DATABRICKS_CLIENT_ID: ${{ secrets.DATABRICKS_ACC_CLIENT_ID }}
      DATABRICKS_CLIENT_SECRET: ${{ secrets.DATABRICKS_ACC_CLIENT_SECRET }}
      DATABRICKS_BUNDLE_ENV: acc

    steps:
      # ------------------------------------------------------------
      # 1ï¸âƒ£ Checkout main branch
      # ------------------------------------------------------------
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ------------------------------------------------------------
      # 2ï¸âƒ£ Install Databricks CLI
      # ------------------------------------------------------------
      - name: Install Databricks CLI
        uses: databricks/setup-cli@v0.246.0

      # ------------------------------------------------------------
      # 3ï¸âƒ£ Install uv (REQUIRED for bundle build)
      # ------------------------------------------------------------
      - name: Install uv
        uses: astral-sh/setup-uv@v5

      # ------------------------------------------------------------
      # 4ï¸âƒ£ Configure Databricks CLI (ACC profile)
      # ------------------------------------------------------------
      - name: Configure Databricks CLI (ACC)
        run: |
          mkdir -p ~/.databricks
          cat > ~/.databrickscfg << EOF
          [acc]
          host = ${DATABRICKS_HOST}
          client_id = ${DATABRICKS_CLIENT_ID}
          client_secret = ${DATABRICKS_CLIENT_SECRET}
          EOF

      # ------------------------------------------------------------
      # 5ï¸âƒ£ Deploy bundle to ACC workspace
      # ------------------------------------------------------------
      - name: Deploy bundle to ACC workspace
        run: |
          databricks bundle deploy \
            --profile acc \
            --var="git_sha=${{ github.sha }}" \
            --var="branch=main"
