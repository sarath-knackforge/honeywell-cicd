
resources:
  jobs:
    deployment:
      name: ${bundle.name}-workflow

      tags:
        project_name: "model-deploy"

      environments:
        - environment_key: default
          spec:
            client: "3"
            # dependencies:
            #   - ../dist/*.whl

      tasks:

        # ------------------------------------------------------------
        # (0) TRAIN MODEL â€” produces candidate_run_id
        # ------------------------------------------------------------
        # - task_key: train_model
        #   environment_key: default
        #   notebook_task:
        #     notebook_path: "../scripts/train_register_custom_model.ipynb"

        # ------------------------------------------------------------
        # (1) CHECK MODEL VERSION (compare metrics)
        # ------------------------------------------------------------
        - task_key: validating_the_model
          environment_key: default
          # depends_on:
          #   - task_key: train_model
          spark_python_task:
            python_file: "../scripts/model_validation.ipynb"
            parameters:
              - "--env"
              - "${bundle.target}"
              - "--model_name"
              - "${{tasks.train_model.values.model_name}}"
              - "--model_uri"
              - "{{tasks.train_model.values.model_uri}}"
              - "--candidate_run_id"
              - "{{tasks.train_model.values.candidate_run_id}}"

        # ------------------------------------------------------------
        # (2) SHOULD WE SKIP DEPLOYMENT? (metric comparison result)
        # ------------------------------------------------------------
        - task_key: model_deploy_decision
          # condition_task:
          #   op: "EQUAL_TO"
          #   left: "{{tasks.validating_the_model.values.skip_deploy}}"
          #   right: "TRUE"
          depends_on:
            - task_key: validating_the_model
          spark_python_task:
            notebook_path: "../scripts/deploy_model.ipynb"
            parameters:
                - "--env"
                - "${bundle.target}"
                - "--model_name"
                - "${{tasks.train_model.values.model_name}}"
                - "--model_version"
                - "{{tasks.check_model_version.values.model_version}}"
                - "--timeout_sec"
                - "500"
                - "--wait_for_ready"

        # ------------------------------------------------------------
        # (3) SEND APPROVAL EMAIL (only if not skipped)
        # ------------------------------------------------------------
        - task_key: model_promotion_and_champion_to_challenger
          # environment_key: default
          depends_on:
            - task_key: validating_the_model
              outcome: "false"
          spark_python_task:
            python_file: "../scripts/promote_model.ipynb"
            parameters:
                - "--candidate_run_id"
                - "{{tasks.train_model.values.candidate_run_id}}"
                - "--model_name"
                - "${{tasks.train_model.values.model_name}}"


        # # ------------------------------------------------------------
        # # (7) CONTAINERIZE AND PUSH TO ECR
        # # ------------------------------------------------------------
        # - task_key: containerize_to_ecr
        #   environment_key: default
        #   depends_on:
        #     - task_key: deploy_model
        #   spark_python_task:
        #     python_file: "../scripts/model_containerize.py"
        #     parameters:
        #       - "--model_name"
        #       - "${var.model_name}"
